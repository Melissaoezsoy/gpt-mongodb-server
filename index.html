<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>GPT Feedback</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fdfdfd;
    }

    #verlauf {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      background: #fafafa;
    }

    #verlauf p {
      margin: 6px 0;
    }

    #verlauf hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 10px 0;
    }

    textarea, input[type="text"] {
      width: 100%;
      font-size: 1rem;
    }

    button {
      background-color: #2e8b57;
      color: white;
      padding: 10px 20px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #246b46;
    }
  </style>
</head>
<body>
  <h1>1. Was hat die Lehrperson gut gemacht?</h1>

  <div id="verlauf"></div>

  <label for="teilnehmerId">Teilnehmer-ID:</label><br>
  <input type="text" id="teilnehmerId" placeholder="z. B. TN-001"><br><br>

  <textarea id="feedback" rows="6" cols="80" placeholder="Schreiben Sie hier..."></textarea><br>
  <button onclick="senden()">Absenden</button>

  <script>
    const verlauf = [];

    async function senden() {
      const feedback = document.getElementById("feedback").value;
      const userId = document.getElementById("teilnehmerId").value;
      const verlaufBox = document.getElementById("verlauf");

      if (!feedback.trim() || !userId.trim()) {
        verlaufBox.innerHTML = "<p style='color: red;'>⚠️ Bitte geben Sie sowohl Feedback als auch Ihre ID ein.</p>" + verlaufBox.innerHTML;
        return;
      }

      verlauf.push({ role: "user", content: feedback });

      // zeige "denkt nach"
      verlaufBox.innerHTML = `
        <p><strong>Du:</strong> ${feedback}</p>
        <p><em>⏳ Agent denkt nach...</em></p>
        <hr>
      ` + verlaufBox.innerHTML;

      try {
        const res = await fetch("/save-feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, feedback, messages: verlauf })
        });

        if (!res.ok) throw new Error("Serverfehler");
        const reply = await res.text();

        verlauf.push({ role: "assistant", content: reply });

        // Verlauf neu aufbauen mit letzter Antwort ganz oben
        let verlaufHtml = "";
        for (let i = verlauf.length - 1; i >= 0; i--) {
          const msg = verlauf[i];
          const tag = msg.role === "user" ? "Du" : "Agent";
          verlaufHtml += `<p><strong>${tag}:</strong> ${msg.content}</p><hr>`;
        }
        verlaufBox.innerHTML = verlaufHtml;

        document.getElementById("feedback").value = ""; // Eingabe leeren
      } catch (err) {
        console.error(err);
        verlaufBox.innerHTML = "<p style='color: red;'>❌ Fehler beim Abrufen der Antwort.</p>" + verlaufBox.innerHTML;
      }
    }
  </script>
</body>
</html>
